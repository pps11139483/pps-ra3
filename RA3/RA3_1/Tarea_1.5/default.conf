# =========================================
# PRÁCTICA 4: ANTI-DOS (Nativo en Nginx)
# =========================================
# Define una zona de límite: 10 peticiones por segundo por IP
limit_req_zone $binary_remote_addr zone=anti_dos:10m rate=10r/s;

server {
    listen 80;
    server_name localhost;
    # Redirigir todo a HTTPS en el puerto 8443
    return 301 https://localhost:8443$request_uri;
}

server {
    listen 443 ssl;
    server_name localhost;

    # =========================================
    # PRÁCTICA 1: SSL & HARDENING
    # =========================================
    # Certificados Snakeoil
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

    # HSTS (Hardening)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    
    # CSP (Hardening)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline';";
    
    # Ocultar versión (ServerTokens ProductOnly equivalente)
    server_tokens off;

    # =========================================
    # PRÁCTICA 2 & 3: WAF & OWASP
    # =========================================
    modsecurity on;
    modsecurity_rules_file /etc/nginx/modsec_includes.conf;

    # Directorio Raíz
    root /var/www/html;
    index index.html index.htm index.php;

    # =========================================
    # APLICAR ANTI-DOS
    # =========================================
    # Aplicamos la zona definida arriba. 
    # burst=5 permite picos breves, nodelay rechaza el exceso inmediatamente.
    limit_req zone=anti_dos burst=5 nodelay;

    # Configuración para procesar PHP (necesario para post.php)
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
    }
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # Regla personalizada de prueba (Práctica 3)
    # Bloquea el parámetro testparam si contiene la palabra "test"
    modsecurity_rules '
        SecRule ARGS:testparam "@contains test" "id:1234,phase:2,deny,status:403,msg:\'Cazado por Ciberseguridad\'"
    ';
}